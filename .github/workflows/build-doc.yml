name: Build documentation

on:
  workflow_dispatch:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

env:
  USE_CACHE: "true"

jobs:
  build-doc:
    runs-on: "ubuntu-latest"
    steps:
      - uses: actions/checkout@v4

      - name: Setup miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          miniconda-version: "latest"
          auto-update-conda: true

      - name: Update environment
        run: conda env update -f environment_doc.yml

      - name: Cache Sphinx-Gallery Examples
        uses: actions/cache@v4
        if: env.USE_CACHE == 'true'
        with:
          path: /examples/
          key: doc-examples-${{ hashFiles('fedoo/_version.py') }}

      - name: Cache Sphinx build directory
        uses: actions/cache@v4
        if: env.USE_CACHE == 'true'
        with:
          path: doc/_build/
          key: doc-examples-${{ hashFiles('fedoo/_version.py') }}

      - name: Build Documentation
        run: make -C docs html

      - name: Upload HTML documentation
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: docs-build
          path:
            docs/_build/html/
